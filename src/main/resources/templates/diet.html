<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset='utf-8' />
    <meta name="_csrf" th:content="${_csrf.token}" />

    <!-- Incluir Toastify.js -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Incluir SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Incluir Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<body>
<!-- Bot√≥n para ir atr√°s -->
<div class="profile-back">
    <a th:href="@{/home}" class="button back-button">Volver a Inicio</a>
</div>
<div class="diet-container">
    <h1>Gesti√≥n de Dietas</h1>
    <p>Aqu√≠ puedes buscar alimentos, a√±adirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la b√∫squeda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar m√°s</button>
    </div>

    <h2>Registro Diario</h2>
    <div id="dailyLog"></div>
    <p id="calorieSummary"></p>
    <div>
        <button onclick="deleteDailyLogFromDatabase()">Guardar y Empezar Nuevo Registro</button>
    </div>

    <h2>Historial de Registros</h2>
    <label for="logSelector">Seleccionar Registro:</label>
    <select id="logSelector" onchange="loadSelectedDailyLog()"></select>
    <button onclick="loadDailyLogHistory()">Cargar Historial</button>

    <h2>Resumen Nutricional</h2>
    <p><b>Objetivo Cal√≥rico:</b> <span id="calorieGoalDisplay">0</span> kcal</p>
    <p><b>Calor√≠as Consumidas:</b> <span id="totalCalories">0</span> kcal</p>
    <p><b>Prote√≠nas:</b> <span id="totalProteins">0</span> g</p>
    <p><b>Carbohidratos:</b> <span id="totalCarbs">0</span> g</p>
    <p><b>Grasas:</b> <span id="totalFats">0</span> g</p>

    <!-- Gr√°fica de seguimiento de la dieta -->
    <h2>Seguimiento de la Dieta</h2>
    <div style="width: 80%; margin: auto;">
        <canvas id="dietProgressChart"></canvas>
    </div>
    <div id="dietAnalysis" style="margin-top: 20px;"></div>

</div>
<script>
    // Obtener el token CSRF desde el meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // Configurar Axios para incluir el token CSRF autom√°ticamente
    axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;

    // Funci√≥n para mostrar mensajes con Toastify
    function showToast(message, color) {
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: color,
        }).showToast();
    }

    // Cargar el registro diario desde el backend
    function loadDailyLogFromDatabase() {
        axios.get(`/api/daily-log`)
            .then((response) => {
                const dailyLog = response.data;
                const logContainer = document.getElementById('dailyLog');
                logContainer.innerHTML = '';

                document.getElementById('calorieGoalDisplay').innerText = dailyLog.calorieGoal || 2000;
                document.getElementById('totalCalories').innerText = dailyLog.totalCalories || 0;
                document.getElementById('totalProteins').innerText = dailyLog.totalProteins || 0;
                document.getElementById('totalCarbs').innerText = dailyLog.totalCarbs || 0;
                document.getElementById('totalFats').innerText = dailyLog.totalFats || 0;

                if (!dailyLog.foods || dailyLog.foods.length === 0) {
                    logContainer.innerHTML = '<p>No se han a√±adido alimentos.</p>';
                    return;
                }

                let table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Descripci√≥n</th>
                            <th>Calor√≠as</th>
                            <th>Prote√≠nas</th>
                            <th>Carbohidratos</th>
                            <th>Grasas</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');
                dailyLog.foods.forEach((food) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${food.imageUrl}" alt="${food.name}" style="width:50px; height:50px;"></td>
                        <td>${food.name}</td>
                        <td>${food.calories || 0} kcal</td>
                        <td>${food.proteins || 0} g</td>
                        <td>${food.carbs || 0} g</td>
                        <td>${food.fats || 0} g</td>
                        <td><button onclick="removeFromDailyLog(${food.id})">Eliminar</button></td>
                    `;
                    tbody.appendChild(row);
                });

                logContainer.appendChild(table);
            })
            .catch((error) => {
                console.error("Error al cargar el registro diario:", error);
                showToast("Error al cargar el registro diario", "#f44336");
            });
    }



    // A√±adir alimentos al registro diario en el backend
    async function addToDailyLog(name, calories, proteins, carbs, fats, imageUrl, index) {
        try {
            // Obtener los gramos especificados por el usuario
            const gramsInput = document.getElementById(`gramsInput${index}`);
            const grams = parseFloat(gramsInput.value) || 100; // Por defecto, 100g si est√° vac√≠o

            // Ajustar los valores nutricionales en funci√≥n de los gramos
            const factor = grams / 100;

            // Convertir a n√∫meros y redondear a 2 decimales
            const adjustedCalories = Number((calories * factor).toFixed(2));
            const adjustedProteins = Number((proteins * factor).toFixed(2));
            const adjustedCarbs = Number((carbs * factor).toFixed(2));
            const adjustedFats = Number((fats * factor).toFixed(2));

            // Obtener el registro activo
            const response = await axios.get(`/api/daily-log`);
            let dailyLogId = response.data.id;

            // Si no hay un registro activo, crear uno nuevo
            if (!dailyLogId) {
                const newLogResponse = await axios.post(`/api/daily-log/new`);
                dailyLogId = newLogResponse.data.id;
            }

            // Crear el objeto de alimento con los datos ajustados
            const food = {
                name: name,
                calories: adjustedCalories,
                proteins: adjustedProteins,
                carbs: adjustedCarbs,
                fats: adjustedFats,
                grams: grams,
                imageUrl: imageUrl,
                dailyLogId: dailyLogId
            };

            // Enviar el alimento al backend
            await axios.post('/api/daily-log/add-food', food);

            showToast(`A√±adido: ${name} (${adjustedCalories} kcal)`, "#4caf50");
            await loadDailyLogFromDatabase();

        } catch (error) {
            console.error("Error al a√±adir alimento:", error);
            showToast("Error al a√±adir el alimento", "#f44336");
        }
    }






    // Eliminar alimentos del registro diario en el backend
    function removeFromDailyLog(foodId) {
        axios.delete(`/api/daily-log/remove-food/${foodId}`)
            .then(() => {
                showToast("Alimento eliminado correctamente", "#f44336");
                loadDailyLogFromDatabase();
            })
            .catch((error) => {
                console.error("Error al eliminar el alimento:", error);
                showToast("Error al eliminar el alimento", "#f44336");
            });
    }

    // Buscar alimentos desde el backend y mostrarlos
    function searchFoods() {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            showToast("Por favor, introduce un t√©rmino de b√∫squeda.", "#ff9800");
            return;
        }

        axios.get(`/api/foods/search?query=${query}`)
            .then((response) => {
                displayFoodResults(response.data);
            })
            .catch((error) => {
                console.error("Error al buscar alimentos:", error);
                showToast("Hubo un error al buscar los alimentos", "#f44336");
            });
    }

    // Mostrar los resultados de la b√∫squeda de alimentos
    function displayFoodResults(results) {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (!results || results.length === 0 || results[0].error) {
            resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
            return;
        }

        let table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Descripci√≥n</th>
                    <th>Calor√≠as (100g)</th>
                    <th>Prote√≠nas</th>
                    <th>Carbohidratos</th>
                    <th>Grasas</th>
                    <th>Gramos Consumidos</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        results.forEach((food, index) => {
            if (!food.name) return;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${food.image_url}" alt="${food.name}" style="width:50px; height:50px;"></td>
                <td>${food.name}</td>
                <td>${food.calories || 0} kcal</td>
                <td>${food.proteins || 0} g</td>
                <td>${food.carbs || 0} g</td>
                <td>${food.fats || 0} g</td>
                <td><input type="number" id="gramsInput${index}" placeholder="100" value="100" min="1" style="width:60px;"></td>
                <td><button onclick="addToDailyLog('${food.name}', ${food.calories}, ${food.proteins}, ${food.carbs}, ${food.fats}, '${food.image_url}', ${index})">A√±adir</button></td>
            `;
            tbody.appendChild(row);
        });

        resultsContainer.appendChild(table);
    }


    async function deleteDailyLogFromDatabase() {
        try {
            const { value: newCalorieGoal } = await Swal.fire({
                title: 'Nuevo Objetivo Cal√≥rico',
                input: 'number',
                inputLabel: 'Ingresa el nuevo objetivo cal√≥rico (kcal)',
                inputPlaceholder: 'Ejemplo: 2000',
                inputAttributes: {
                    min: 1000,
                    max: 5000,
                    step: 50
                },
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar'
            });

            if (!newCalorieGoal) {
                Swal.fire('Cancelado', 'No se cre√≥ un nuevo registro.', 'info');
                return;
            }

            // Paso 1: Cerrar el registro actual
            const closeResponse = await axios.put('/api/daily-log/close');
            console.log("Cierre de registro:", closeResponse.data);

            // Paso 2: Crear un nuevo registro
            const newLogResponse = await axios.post('/api/daily-log/new', {
                calorieGoal: newCalorieGoal
            });
            console.log("Nuevo registro creado:", newLogResponse.data);

            showToast(`Nuevo registro creado con objetivo de ${newCalorieGoal} kcal`, "#4caf50");

            // Paso 3: Recargar datos
            await loadDailyLogHistory();
            await loadDailyLogFromDatabase();

        } catch (error) {
            // Mostrar detalles espec√≠ficos del error
            if (error.response) {
                console.error("Respuesta del servidor:", error.response.data);
                showToast(`Error: ${error.response.data.message || "No se pudo crear el nuevo registro"}`, "#f44336");
            } else if (error.request) {
                console.error("Sin respuesta del servidor:", error.request);
                showToast("Sin respuesta del servidor", "#f44336");
            } else {
                console.error("Error al configurar la solicitud:", error.message);
                showToast("Error desconocido", "#f44336");
            }
        }
    }


    async function loadDailyLogHistory() {
        return axios.get(`/api/daily-log/history`)
            .then((response) => {
                const logSelector = document.getElementById('logSelector');
                logSelector.innerHTML = '';

                if (response.data.length === 0) {
                    logSelector.innerHTML = '<option disabled>No hay registros anteriores</option>';
                    return;
                }

                response.data.forEach((log) => {
                    let createdAt = new Date(log.createdAt);
                    let formattedCreatedAt = `${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;

                    let option = document.createElement('option');
                    option.value = log.id;
                    option.textContent = `${log.totalCalories} kcal - Creado: ${formattedCreatedAt}`;
                    logSelector.appendChild(option);
                });

                logSelector.selectedIndex = response.data.length - 1; // Seleccionar el √∫ltimo registro autom√°ticamente
                loadSelectedDailyLog();
            })
            .catch((error) => {
                console.error("Error al cargar el historial:", error);
                showToast("Error al cargar el historial", "#f44336");
            });
    }

    function loadSelectedDailyLog() {
        let logSelector = document.getElementById('logSelector');
        if (logSelector.options.length === 0) return; // Evita errores si no hay registros disponibles

        let selectedLogId = logSelector.value;
        axios.get(`/api/daily-log/${selectedLogId}`)
            .then((response) => {
                updateDailyLogUI(response.data);
            })
            .catch((error) => {
                console.error("Error al cargar el registro seleccionado:", error);
                showToast("Error al cargar el registro seleccionado", "#f44336");
            });
    }


    // Funci√≥n para actualizar la interfaz con los datos del registro seleccionado
    function updateDailyLogUI(dailyLog) {
        const logContainer = document.getElementById('dailyLog');
        logContainer.innerHTML = '';

        // Leer el valor del objetivo cal√≥rico desde el input
        const calorieGoalInput = document.getElementById('calorieGoalInput');
        const calorieGoal = calorieGoalInput && calorieGoalInput.value ? parseInt(calorieGoalInput.value) : dailyLog.calorieGoal;

        // Actualizar el Resumen Nutricional con el objetivo ingresado
        document.getElementById('calorieGoalDisplay').innerText = calorieGoal;
        document.getElementById('totalCalories').innerText = dailyLog.totalCalories || 0;
        document.getElementById('totalProteins').innerText = dailyLog.totalProteins || 0;
        document.getElementById('totalCarbs').innerText = dailyLog.totalCarbs || 0;
        document.getElementById('totalFats').innerText = dailyLog.totalFats || 0;

        // Mostrar fecha de creaci√≥n
        let createdAt = new Date(dailyLog.createdAt);
        let createdAtText = `Creado: ${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;
        logContainer.innerHTML += `<p>${createdAtText}</p>`;

        if (!dailyLog.foods || dailyLog.foods.length === 0) {
            logContainer.innerHTML += '<p>No se han a√±adido alimentos.</p>';
            return;
        }

        // Crear la tabla de alimentos
        let table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Descripci√≥n</th>
                    <th>Calor√≠as</th>
                    <th>Prote√≠nas</th>
                    <th>Carbohidratos</th>
                    <th>Grasas</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        dailyLog.foods.forEach((food) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${food.imageUrl || 'https://via.placeholder.com/50'}" alt="${food.name}" style="width:50px; height:50px;"></td>
                <td>${food.name}</td>
                <td>${food.calories || 0} kcal</td>
                <td>${food.proteins || 0} g</td>
                <td>${food.carbs || 0} g</td>
                <td>${food.fats || 0} g</td>
                <td><button onclick="removeFromDailyLog(${food.id})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });

        logContainer.appendChild(table);
    }

    function updateCalorieGoal() {
        const calorieGoalInput = document.getElementById('calorieGoalInput').value;
        const calorieGoal = parseInt(calorieGoalInput);

        if (!calorieGoal || isNaN(calorieGoal) || calorieGoal <= 0) {
            showToast("Por favor, introduce un objetivo cal√≥rico v√°lido.", "#ff9800");
            return;
        }

        // Obtener el ID del DailyLog actualmente seleccionado
        const selectedLogId = document.getElementById('logSelector').value;

        // Enviar la solicitud al backend con el ID actual
        axios.put('/api/daily-log/update-calorie-goal', {
            id: selectedLogId,
            calorieGoal: calorieGoal
        })
        .then(() => {
            showToast("Objetivo cal√≥rico actualizado a " + calorieGoal + " kcal", "#4caf50");
            loadDailyLogFromDatabase();
        })
        .catch((error) => {
            console.error("Error al actualizar el objetivo cal√≥rico:", error);
            showToast("Error al actualizar el objetivo cal√≥rico", "#f44336");
        });
    }

    // Cargar el registro cuando se inicia la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        loadDailyLogFromDatabase();
        loadDailyLogHistory();
    });

</script>

<!-- Incluir Chart.js -->
<script>
    let dietProgressChart;

    // Funci√≥n para cargar la gr√°fica de progreso
    function loadDietProgressChart() {
        axios.get('/api/daily-log/history')
            .then(response => {
                const logs = response.data;

                const labels = logs.map(log => new Date(log.createdAt).toLocaleDateString());
                const totalCalories = logs.map(log => log.totalCalories);
                const calorieGoals = logs.map(log => log.calorieGoal);

                const ctx = document.getElementById('dietProgressChart').getContext('2d');
                if (dietProgressChart) dietProgressChart.destroy();

                dietProgressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Calor√≠as Consumidas',
                                data: totalCalories,
                                borderColor: '#4caf50',
                                fill: false
                            },
                            {
                                label: 'Objetivo Cal√≥rico',
                                data: calorieGoals,
                                borderColor: '#f44336',
                                borderDash: [5, 5],
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error al cargar datos de la dieta:", error);
            });
    }


    // Funci√≥n para mostrar el an√°lisis de la dieta
    function analyzeDiet(calorieGoal, totalCalories, totalProteins, totalCarbs, totalFats) {
        const analysisContainer = document.getElementById('dietAnalysis');
        let analysis = '';

        if (totalCalories < calorieGoal) {
            analysis += `<p>‚ö° Est√°s por debajo del objetivo cal√≥rico.</p>`;
        } else if (totalCalories > calorieGoal) {
            analysis += `<p>‚ö†Ô∏è Has superado tu objetivo cal√≥rico.</p>`;
        } else {
            analysis += `<p>‚úÖ Has alcanzado tu objetivo cal√≥rico. ¬°Buen trabajo!</p>`;
        }

        if (totalProteins < 50) analysis += `<p>üí™ A√±ade m√°s prote√≠nas.</p>`;
        if (totalCarbs > 250) analysis += `<p>ü•ñ Reduzca carbohidratos.</p>`;
        if (totalFats > 70) analysis += `<p>ü•ë Reduce las grasas.</p>`;

        analysisContainer.innerHTML = analysis;
    }

    // Cargar el gr√°fico al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        loadDietProgressChart();
    });
</script>
</body>
</html>
