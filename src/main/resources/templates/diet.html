<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="diet-container">
    <h1>Gestión de Dietas</h1>
    <p>Aquí puedes buscar alimentos, añadirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la búsqueda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar más</button>
    </div>

    <h2>Registro Diario</h2>
    <div id="dailyLog"></div>
    <button onclick="saveDailyLog()">Guardar Registro</button>
</div>

<script>
    let currentOffset = 0;
    const limit = 5; // Límite de resultados por página

    // Función para buscar alimentos
    function searchFoods(isNewSearch = false) {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            alert("Por favor, introduce un término de búsqueda.");
            return;
        }

        if (isNewSearch) {
            currentOffset = 0; // Reiniciar el offset para una nueva búsqueda
            document.getElementById('searchResults').innerHTML = ''; // Limpiar resultados previos
        }

        axios.get(`/api/foods/search?query=${query}&limit=${limit}&offset=${currentOffset}`)
            .then(response => {
                const results = response.data.foods;
                const resultsContainer = document.getElementById('searchResults');

                if (!results || results.length === 0) {
                    if (isNewSearch) {
                        resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
                    }
                    document.getElementById('loadMoreButton').style.display = 'none';
                    return;
                }

                // Crear la tabla si es una nueva búsqueda
                let table = resultsContainer.querySelector('table');
                if (!table) {
                    table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Energía (kcal)</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    resultsContainer.appendChild(table);
                }

                // Agregar los nuevos alimentos al cuerpo de la tabla
                const tbody = table.querySelector('tbody');
                results.forEach(food => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${food.description}</td>
                        <td>${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 'N/A'}</td>
                        <td><button onclick="addToLog('${food.description}', ${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 0})">Añadir</button></td>
                    `;
                    tbody.appendChild(row);
                });

                // Mostrar el botón "Cargar más" si hay más resultados
                if (results.length === limit) {
                    document.getElementById('loadMoreButton').style.display = 'block';
                } else {
                    document.getElementById('loadMoreButton').style.display = 'none';
                }

                currentOffset += limit; // Incrementar el offset para la próxima carga
            })
            .catch(error => {
                console.error("Error al buscar alimentos:", error);
                alert("Hubo un error al buscar los alimentos. Por favor, intenta de nuevo.");
            });
    }

    function loadMoreFoods() {
        searchFoods(false);
    }

    // Registro diario
    const dailyLog = [];

    function addToLog(description, energy) {
        dailyLog.push({ description, energy });
        updateDailyLog();
    }

    function updateDailyLog() {
        const logContainer = document.getElementById('dailyLog');
        logContainer.innerHTML = '';

        if (dailyLog.length === 0) {
            logContainer.innerHTML = '<p>No se han añadido alimentos.</p>';
            return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Energía (kcal)</th>
                    <th>Acción</th>
                </tr>
            </thead>
        `;

        const tbody = document.createElement('tbody');
        dailyLog.forEach((food, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.description}</td>
                <td>${food.energy}</td>
                <td><button onclick="removeFromLog(${index})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        logContainer.appendChild(table);
    }

    function removeFromLog(index) {
        dailyLog.splice(index, 1); // Eliminar el alimento por índice
        updateDailyLog();
    }

    function saveDailyLog() {
        if (dailyLog.length === 0) {
            alert("No hay alimentos para guardar.");
            return;
        }

        // Simular guardado en el backend
        console.log("Registro diario guardado:", dailyLog);
        alert("Registro guardado exitosamente.");
        dailyLog.length = 0; // Limpiar el registro
        updateDailyLog();
    }
</script>
</body>
</html>
