<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset='utf-8' />
    <meta name="_csrf" th:content="${_csrf.token}" />

    <!-- Incluir Toastify.js -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

</head>
<body>
<!-- Botón para ir atrás -->
<div class="profile-back">
    <a th:href="@{/home}" class="button back-button">Volver a Inicio</a>
</div>
<div class="diet-container">
    <h1>Gestión de Dietas</h1>
    <p>Aquí puedes buscar alimentos, añadirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la búsqueda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar más</button>
    </div>

    <h2>Registro Diario</h2>
    <label for="calorieGoal">Objetivo calórico diario (kcal):</label>
    <input type="number" id="calorieGoal" placeholder="2000">
    <div id="dailyLog"></div>
    <p id="calorieSummary"></p>
    <div>
        <button onclick="saveDailyLogToDatabase()">Guardar Registro</button>
        <button onclick="deleteDailyLogFromDatabase()">Empezar Nuevo Registro</button>
    </div>
</div>
<script>
    // Obtener el token CSRF desde el meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // Configurar Axios para incluir el token CSRF automáticamente
    axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;

    // Función para mostrar mensajes con Toastify
    function showToast(message, color) {
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: color,
        }).showToast();
    }

    // Cargar el registro diario desde el backend
    function loadDailyLogFromDatabase() {
        axios.get(`/api/daily-log`)
            .then((response) => {
                const dailyLog = response.data.foods;
                const logContainer = document.getElementById('dailyLog');
                logContainer.innerHTML = '';

                if (!dailyLog || dailyLog.length === 0) {
                    logContainer.innerHTML = '<p>No se han añadido alimentos.</p>';
                    return;
                }

                let table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Descripción</th>
                            <th>Calorías</th>
                            <th>Proteínas</th>
                            <th>Carbohidratos</th>
                            <th>Grasas</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');
                dailyLog.forEach((food) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${food.imageUrl}" alt="${food.name}" style="width:50px; height:50px;"></td>  <!-- image_url en lugar de image -->
                        <td>${food.name}</td>
                        <td>${food.calories || 0} kcal</td>
                        <td>${food.proteins || 0} g</td>
                        <td>${food.carbs || 0} g</td>
                        <td>${food.fats || 0} g</td>
                        <td><button onclick="removeFromDailyLog(${food.id})">Eliminar</button></td>
                    `;
                    tbody.appendChild(row);
                });

                logContainer.appendChild(table);
            })
            .catch((error) => {
                console.error("Error al cargar el registro diario:", error);
                showToast("Error al cargar el registro diario", "#f44336");
            });
    }


    // Añadir alimentos al registro diario en el backend
    function addToDailyLog(name, calories, proteins, carbs, fats, imageUrl) {
        const food = { name, calories, proteins, carbs, fats, imageUrl };
        axios.post('/api/daily-log/add-food', food)
            .then(() => {
                showToast(`Añadido: ${name} (${calories} kcal)`, "#4caf50");
                loadDailyLogFromDatabase();
            })
            .catch((error) => {
                console.error("Error al añadir alimento:", error);
                showToast("Error al añadir el alimento", "#f44336");
            });
    }

    // Eliminar alimentos del registro diario en el backend
    function removeFromDailyLog(foodId) {
        axios.delete(`/api/daily-log/remove-food/${foodId}`)
            .then(() => {
                showToast("Alimento eliminado correctamente", "#f44336");
                loadDailyLogFromDatabase();
            })
            .catch((error) => {
                console.error("Error al eliminar el alimento:", error);
                showToast("Error al eliminar el alimento", "#f44336");
            });
    }

    // Buscar alimentos desde el backend y mostrarlos
    function searchFoods() {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            showToast("Por favor, introduce un término de búsqueda.", "#ff9800");
            return;
        }

        axios.get(`/api/foods/search?query=${query}`)
            .then((response) => {
                displayFoodResults(response.data);
            })
            .catch((error) => {
                console.error("Error al buscar alimentos:", error);
                showToast("Hubo un error al buscar los alimentos", "#f44336");
            });
    }

    // Mostrar los resultados de la búsqueda de alimentos
    function displayFoodResults(results) {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (!results || results.length === 0 || results[0].error) {
            resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
            return;
        }

        let table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Descripción</th>
                    <th>Calorías</th>
                    <th>Proteínas</th>
                    <th>Carbohidratos</th>
                    <th>Grasas</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        results.forEach((food) => {
            if (!food.name) return;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${food.image_url}" alt="${food.name}" style="width:50px; height:50px;"></td>
                <td>${food.name}</td>
                <td>${food.calories || 0} kcal</td>
                <td>${food.proteins || 0} g</td>
                <td>${food.carbs || 0} g</td>
                <td>${food.fats || 0} g</td>
                <td><button onclick="addToDailyLog('${food.name}', ${food.calories}, ${food.proteins}, ${food.carbs}, ${food.fats}, '${food.image_url}')">Añadir</button></td>
            `;
            tbody.appendChild(row);
        });

        resultsContainer.appendChild(table);
    }

    // Cargar el registro cuando se inicia la página
    document.addEventListener('DOMContentLoaded', () => {
        loadDailyLogFromDatabase();
    });

</script>

</body>
</html>
