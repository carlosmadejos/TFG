<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<!-- Botón para ir atrás -->
<div class="profile-back">
    <a th:href="@{/home}" class="button back-button">Volver a Inicio</a>
</div>
<div class="diet-container">
    <h1>Gestión de Dietas</h1>
    <p>Aquí puedes buscar alimentos, añadirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la búsqueda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar más</button>
    </div>

    <h2>Registro Diario</h2>
    <label for="calorieGoal">Objetivo calórico diario (kcal):</label>
    <input type="number" id="calorieGoal" placeholder="2000">
    <div id="dailyLog"></div>
    <p id="calorieSummary"></p>
    <button onclick="saveDailyLog()">Guardar Registro</button>
</div>
<script>
    let currentOffset = 0;
    const limit = 5; // Límite de resultados por página
    const username = "Carlos"; // Cambiar dinámicamente según el usuario autenticado
    let dailyLog = []; // Inicialización del registro diario

    function loadDailyLogFromStorage() {
        const storedLog = localStorage.getItem(`dailyLog_${username}`);
        return storedLog ? JSON.parse(storedLog) : [];
    }

    function saveDailyLogToStorage() {
        localStorage.setItem(`dailyLog_${username}`, JSON.stringify(dailyLog));
    }

    function initializeDailyLog() {
        dailyLog = loadDailyLogFromStorage(); // Cargar desde localStorage
        updateDailyLog(); // Actualizar la tabla sin duplicados
    }

    function searchFoods(isNewSearch = false) {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            alert("Por favor, introduce un término de búsqueda.");
            return;
        }

        if (isNewSearch) {
            currentOffset = 0; // Reiniciar el offset para una nueva búsqueda
            document.getElementById('searchResults').innerHTML = ''; // Limpiar resultados previos
        }

        axios.get(`/api/foods/search?query=${query}&limit=${limit}&offset=${currentOffset}`)
            .then(response => {
                const results = response.data.foods;
                const resultsContainer = document.getElementById('searchResults');

                if (!results || results.length === 0) {
                    if (isNewSearch) {
                        resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
                    }
                    document.getElementById('loadMoreButton').style.display = 'none';
                    return;
                }

                let table = resultsContainer.querySelector('table');
                if (!table) {
                    table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Energía (kcal)</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    resultsContainer.appendChild(table);
                }

                const tbody = table.querySelector('tbody');
                results.forEach(food => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${food.description}</td>
                        <td>${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 'N/A'}</td>
                        <td><button onclick="addToLog('${food.description}', ${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 0})">Añadir</button></td>
                    `;
                    tbody.appendChild(row);
                });

                if (results.length === limit) {
                    document.getElementById('loadMoreButton').style.display = 'block';
                } else {
                    document.getElementById('loadMoreButton').style.display = 'none';
                }

                currentOffset += limit;
            })
            .catch(error => {
                console.error("Error al buscar alimentos:", error);
                alert("Hubo un error al buscar los alimentos. Por favor, intenta de nuevo.");
            });
    }

    function loadMoreFoods() {
        searchFoods(false);
    }

    function addToLog(description, energy) {
        dailyLog.push({ description, energy });
        updateDailyLog();
        saveDailyLogToStorage();
    }

    function removeFromLog(index) {
        dailyLog.splice(index, 1);
        updateDailyLog();
        saveDailyLogToStorage();
    }

    function updateDailyLog() {
        const logContainer = document.getElementById('dailyLog');
        const calorieGoal = parseInt(document.getElementById('calorieGoal').value) || 0;
        logContainer.innerHTML = '';

        if (dailyLog.length === 0) {
            logContainer.innerHTML = '<p>No se han añadido alimentos.</p>';
            document.getElementById('calorieSummary').textContent = '';
            return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Energía (kcal)</th>
                    <th>Acción</th>
                </tr>
            </thead>
        `;

        const tbody = document.createElement('tbody');
        let totalCalories = 0;

        dailyLog.forEach((food, index) => {
            totalCalories += food.energy;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.description}</td>
                <td>${food.energy}</td>
                <td><button onclick="removeFromLog(${index})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        logContainer.appendChild(table);

        const calorieSummary = document.getElementById('calorieSummary');
        if (calorieGoal > 0) {
            const remainingCalories = calorieGoal - totalCalories;
            calorieSummary.textContent = `Calorías consumidas: ${totalCalories} kcal. ${
                remainingCalories >= 0
                    ? `Te faltan ${remainingCalories} kcal para alcanzar tu objetivo.`
                    : `Has excedido tu objetivo en ${Math.abs(remainingCalories)} kcal.`
            }`;
        } else {
            calorieSummary.textContent = `Calorías consumidas: ${totalCalories} kcal.`;
        }
    }

    document.addEventListener('DOMContentLoaded', initializeDailyLog);
</script>
</body>
</html>
