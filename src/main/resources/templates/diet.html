<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset='utf-8' />
    <meta name="_csrf" th:content="${_csrf.token}" />

    <!-- Incluir Toastify.js -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Incluir SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
<!-- Botón para ir atrás -->
<div class="profile-back">
    <a th:href="@{/home}" class="button back-button">Volver a Inicio</a>
</div>
<div class="diet-container">
    <h1>Gestión de Dietas</h1>
    <p>Aquí puedes buscar alimentos, añadirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la búsqueda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar más</button>
    </div>

    <h2>Registro Diario</h2>
    <label for="calorieGoalInput">Objetivo calórico diario (kcal):</label>
    <input type="number" id="calorieGoalInput" placeholder="2000">
    <div id="dailyLog"></div>
    <p id="calorieSummary"></p>
    <div>
        <button onclick="deleteDailyLogFromDatabase()">Guardar y Empezar Nuevo Registro</button>
    </div>

    <h2>Historial de Registros</h2>
    <label for="logSelector">Seleccionar Registro:</label>
    <select id="logSelector" onchange="loadSelectedDailyLog()"></select>
    <button onclick="loadDailyLogHistory()">Cargar Historial</button>

    <h2>Resumen Nutricional</h2>
    <p><b>Objetivo Calórico:</b> <span id="calorieGoalDisplay">0</span> kcal</p>
    <p><b>Calorías Consumidas:</b> <span id="totalCalories">0</span> kcal</p>
    <p><b>Proteínas:</b> <span id="totalProteins">0</span> g</p>
    <p><b>Carbohidratos:</b> <span id="totalCarbs">0</span> g</p>
    <p><b>Grasas:</b> <span id="totalFats">0</span> g</p>


</div>
<script>
    // Obtener el token CSRF desde el meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // Configurar Axios para incluir el token CSRF automáticamente
    axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;

    // Función para mostrar mensajes con Toastify
    function showToast(message, color) {
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: color,
        }).showToast();
    }

    // Cargar el registro diario desde el backend
    function loadDailyLogFromDatabase() {
        axios.get(`/api/daily-log`)
            .then((response) => {
                const dailyLog = response.data;
                const logContainer = document.getElementById('dailyLog');
                logContainer.innerHTML = '';

                document.getElementById('calorieGoalDisplay').innerText = dailyLog.calorieGoal || 2000;
                document.getElementById('totalCalories').innerText = dailyLog.totalCalories || 0;
                document.getElementById('totalProteins').innerText = dailyLog.totalProteins || 0;
                document.getElementById('totalCarbs').innerText = dailyLog.totalCarbs || 0;
                document.getElementById('totalFats').innerText = dailyLog.totalFats || 0;

                if (!dailyLog.foods || dailyLog.foods.length === 0) {
                    logContainer.innerHTML = '<p>No se han añadido alimentos.</p>';
                    return;
                }

                let table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Descripción</th>
                            <th>Calorías</th>
                            <th>Proteínas</th>
                            <th>Carbohidratos</th>
                            <th>Grasas</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');
                dailyLog.foods.forEach((food) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${food.imageUrl}" alt="${food.name}" style="width:50px; height:50px;"></td>
                        <td>${food.name}</td>
                        <td>${food.calories || 0} kcal</td>
                        <td>${food.proteins || 0} g</td>
                        <td>${food.carbs || 0} g</td>
                        <td>${food.fats || 0} g</td>
                        <td><button onclick="removeFromDailyLog(${food.id})">Eliminar</button></td>
                    `;
                    tbody.appendChild(row);
                });

                logContainer.appendChild(table);
            })
            .catch((error) => {
                console.error("Error al cargar el registro diario:", error);
                showToast("Error al cargar el registro diario", "#f44336");
            });
    }



    // Añadir alimentos al registro diario en el backend
    async function addToDailyLog(name, calories, proteins, carbs, fats, imageUrl) {
        try {
            // Obtener el ID del registro activo
            const response = await axios.get(`/api/daily-log`);
            let dailyLogId = response.data.id;

            // Si no hay un dailyLogId válido, intenta crearlo
            if (!dailyLogId) {
                console.warn("No se encontró un DailyLog activo, creando uno nuevo...");
                const newLogResponse = await axios.post(`/api/daily-log/new`);
                dailyLogId = newLogResponse.data.id; // Asignar el ID del nuevo registro
            }

            // Crear el objeto de alimento
            const food = { name, calories, proteins, carbs, fats, imageUrl, dailyLogId };

            // Enviar el alimento al backend
            await axios.post('/api/daily-log/add-food', food);

            // Mostrar mensaje de éxito
            showToast(`Añadido: ${name} (${calories} kcal)`, "#4caf50");

            // Actualizar el registro en la interfaz
            await loadDailyLogFromDatabase();
        } catch (error) {
            console.error("Error al añadir alimento:", error);
            showToast("Error al añadir el alimento", "#f44336");
        }
    }




    // Eliminar alimentos del registro diario en el backend
    function removeFromDailyLog(foodId) {
        axios.delete(`/api/daily-log/remove-food/${foodId}`)
            .then(() => {
                showToast("Alimento eliminado correctamente", "#f44336");
                loadDailyLogFromDatabase();
            })
            .catch((error) => {
                console.error("Error al eliminar el alimento:", error);
                showToast("Error al eliminar el alimento", "#f44336");
            });
    }

    // Buscar alimentos desde el backend y mostrarlos
    function searchFoods() {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            showToast("Por favor, introduce un término de búsqueda.", "#ff9800");
            return;
        }

        axios.get(`/api/foods/search?query=${query}`)
            .then((response) => {
                displayFoodResults(response.data);
            })
            .catch((error) => {
                console.error("Error al buscar alimentos:", error);
                showToast("Hubo un error al buscar los alimentos", "#f44336");
            });
    }

    // Mostrar los resultados de la búsqueda de alimentos
    function displayFoodResults(results) {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (!results || results.length === 0 || results[0].error) {
            resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
            return;
        }

        let table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Descripción</th>
                    <th>Calorías</th>
                    <th>Proteínas</th>
                    <th>Carbohidratos</th>
                    <th>Grasas</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        results.forEach((food) => {
            if (!food.name) return;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${food.image_url}" alt="${food.name}" style="width:50px; height:50px;"></td>
                <td>${food.name}</td>
                <td>${food.calories || 0} kcal</td>
                <td>${food.proteins || 0} g</td>
                <td>${food.carbs || 0} g</td>
                <td>${food.fats || 0} g</td>
                <td><button onclick="addToDailyLog('${food.name}', ${food.calories}, ${food.proteins}, ${food.carbs}, ${food.fats}, '${food.image_url}')">Añadir</button></td>
            `;
            tbody.appendChild(row);
        });

        resultsContainer.appendChild(table);
    }

    async function deleteDailyLogFromDatabase() {
        try {
            const { value: newCalorieGoal } = await Swal.fire({
                title: 'Nuevo Objetivo Calórico',
                input: 'number',
                inputLabel: 'Ingresa el nuevo objetivo calórico (kcal)',
                inputPlaceholder: 'Ejemplo: 2000',
                inputAttributes: {
                    min: 1000,
                    max: 5000,
                    step: 50
                },
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar'
            });

            if (!newCalorieGoal) {
                Swal.fire('Cancelado', 'No se creó un nuevo registro.', 'info');
                return;
            }

            // Paso 1: Cerrar el registro actual
            const closeResponse = await axios.put('/api/daily-log/close');
            console.log("Cierre de registro:", closeResponse.data);

            // Paso 2: Crear un nuevo registro
            const newLogResponse = await axios.post('/api/daily-log/new', {
                calorieGoal: newCalorieGoal
            });
            console.log("Nuevo registro creado:", newLogResponse.data);

            showToast(`Nuevo registro creado con objetivo de ${newCalorieGoal} kcal`, "#4caf50");

            // Paso 3: Recargar datos
            await loadDailyLogHistory();
            await loadDailyLogFromDatabase();

        } catch (error) {
            // Mostrar detalles específicos del error
            if (error.response) {
                console.error("Respuesta del servidor:", error.response.data);
                showToast(`Error: ${error.response.data.message || "No se pudo crear el nuevo registro"}`, "#f44336");
            } else if (error.request) {
                console.error("Sin respuesta del servidor:", error.request);
                showToast("Sin respuesta del servidor", "#f44336");
            } else {
                console.error("Error al configurar la solicitud:", error.message);
                showToast("Error desconocido", "#f44336");
            }
        }
    }


    async function loadDailyLogHistory() {
        return axios.get(`/api/daily-log/history`)
            .then((response) => {
                const logSelector = document.getElementById('logSelector');
                logSelector.innerHTML = '';

                if (response.data.length === 0) {
                    logSelector.innerHTML = '<option disabled>No hay registros anteriores</option>';
                    return;
                }

                response.data.forEach((log) => {
                    let createdAt = new Date(log.createdAt);
                    let formattedCreatedAt = `${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;

                    let option = document.createElement('option');
                    option.value = log.id;
                    option.textContent = `Registro ${log.id} - ${log.totalCalories} kcal - Creado: ${formattedCreatedAt}`;
                    logSelector.appendChild(option);
                });

                logSelector.selectedIndex = response.data.length - 1; // Seleccionar el último registro automáticamente
                loadSelectedDailyLog();
            })
            .catch((error) => {
                console.error("Error al cargar el historial:", error);
                showToast("Error al cargar el historial", "#f44336");
            });
    }

    function loadSelectedDailyLog() {
        let logSelector = document.getElementById('logSelector');
        if (logSelector.options.length === 0) return; // Evita errores si no hay registros disponibles

        let selectedLogId = logSelector.value;
        axios.get(`/api/daily-log/${selectedLogId}`)
            .then((response) => {
                updateDailyLogUI(response.data);
            })
            .catch((error) => {
                console.error("Error al cargar el registro seleccionado:", error);
                showToast("Error al cargar el registro seleccionado", "#f44336");
            });
    }


    // Función para actualizar la interfaz con los datos del registro seleccionado
    function updateDailyLogUI(dailyLog) {
        const logContainer = document.getElementById('dailyLog');
        logContainer.innerHTML = '';

        // Leer el valor del objetivo calórico desde el input
        const calorieGoalInput = document.getElementById('calorieGoalInput');
        const calorieGoal = calorieGoalInput && calorieGoalInput.value ? parseInt(calorieGoalInput.value) : dailyLog.calorieGoal;

        // Actualizar el Resumen Nutricional con el objetivo ingresado
        document.getElementById('calorieGoalDisplay').innerText = calorieGoal;
        document.getElementById('totalCalories').innerText = dailyLog.totalCalories || 0;
        document.getElementById('totalProteins').innerText = dailyLog.totalProteins || 0;
        document.getElementById('totalCarbs').innerText = dailyLog.totalCarbs || 0;
        document.getElementById('totalFats').innerText = dailyLog.totalFats || 0;

        // Mostrar fecha de creación
        let createdAt = new Date(dailyLog.createdAt);
        let createdAtText = `Creado: ${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;
        logContainer.innerHTML += `<p>${createdAtText}</p>`;

        if (!dailyLog.foods || dailyLog.foods.length === 0) {
            logContainer.innerHTML += '<p>No se han añadido alimentos.</p>';
            return;
        }

        // Crear la tabla de alimentos
        let table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Descripción</th>
                    <th>Calorías</th>
                    <th>Proteínas</th>
                    <th>Carbohidratos</th>
                    <th>Grasas</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        dailyLog.foods.forEach((food) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${food.imageUrl || 'https://via.placeholder.com/50'}" alt="${food.name}" style="width:50px; height:50px;"></td>
                <td>${food.name}</td>
                <td>${food.calories || 0} kcal</td>
                <td>${food.proteins || 0} g</td>
                <td>${food.carbs || 0} g</td>
                <td>${food.fats || 0} g</td>
                <td><button onclick="removeFromDailyLog(${food.id})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });

        logContainer.appendChild(table);
    }

    function updateCalorieGoal() {
        const calorieGoalInput = document.getElementById('calorieGoalInput').value;
        const calorieGoal = parseInt(calorieGoalInput);

        if (!calorieGoal || isNaN(calorieGoal) || calorieGoal <= 0) {
            showToast("Por favor, introduce un objetivo calórico válido.", "#ff9800");
            return;
        }

        // Obtener el ID del DailyLog actualmente seleccionado
        const selectedLogId = document.getElementById('logSelector').value;

        // Enviar la solicitud al backend con el ID actual
        axios.put('/api/daily-log/update-calorie-goal', {
            id: selectedLogId,
            calorieGoal: calorieGoal
        })
        .then(() => {
            showToast("Objetivo calórico actualizado a " + calorieGoal + " kcal", "#4caf50");
            loadDailyLogFromDatabase();
        })
        .catch((error) => {
            console.error("Error al actualizar el objetivo calórico:", error);
            showToast("Error al actualizar el objetivo calórico", "#f44336");
        });
    }





    // Cargar el registro cuando se inicia la página
    document.addEventListener('DOMContentLoaded', () => {
        loadDailyLogFromDatabase();
        loadDailyLogHistory();
    });

</script>

</body>
</html>
