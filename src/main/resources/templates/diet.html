<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dietas</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset='utf-8' />
    <meta name="_csrf" th:content="${_csrf.token}" />
</head>
<body>
<!-- Botón para ir atrás -->
<div class="profile-back">
    <a th:href="@{/home}" class="button back-button">Volver a Inicio</a>
</div>
<div class="diet-container">
    <h1>Gestión de Dietas</h1>
    <p>Aquí puedes buscar alimentos, añadirlos y registrar tu ingesta diaria.</p>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar alimentos...">
        <button onclick="searchFoods(true)">Buscar</button>
    </div>

    <h2>Resultados de la búsqueda</h2>
    <div id="searchResults">
        <p>No se encontraron alimentos.</p>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
        <button id="loadMoreButton" onclick="loadMoreFoods()" style="display:none;">Cargar más</button>
    </div>

    <h2>Registro Diario</h2>
    <label for="calorieGoal">Objetivo calórico diario (kcal):</label>
    <input type="number" id="calorieGoal" placeholder="2000">
    <div id="dailyLog"></div>
    <p id="calorieSummary"></p>
    <div>
        <button onclick="saveDailyLogToDatabase()">Guardar Registro</button>
        <button onclick="deleteDailyLogFromDatabase()">Empezar Nuevo Registro</button>
    </div>
</div>
<script>
    // Obtener el token CSRF desde el meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // Configurar Axios para incluir el token CSRF automáticamente
    axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;

    let currentOffset = 0;
    const limit = 5; // Límite de resultados por página

    let dailyLog = [];
    let calorieGoal = 2000;

    // Cargar el registro diario desde el backend
    function loadDailyLogFromDatabase() {
        axios.get(`/api/daily-log`)
            .then((response) => {
                dailyLog = JSON.parse(response.data.dailyLogJson || '[]'); // Parsear el JSON
                calorieGoal = response.data.calorieGoal || 2000;

                document.getElementById('calorieGoal').value = calorieGoal;
                updateDailyLog();
            })
            .catch((error) => {
                console.error("Error al cargar el registro diario:", error);
                alert("Error al cargar el registro diario.");
            });
    }

    // Guardar o actualizar el registro diario en el backend
    function saveDailyLogToDatabase() {
        const data = {
            dailyLogJson: JSON.stringify(dailyLog), // Convertir a JSON antes de enviar
            calorieGoal: parseInt(document.getElementById('calorieGoal').value) || 2000,
        };

        axios.post(`/api/daily-log`, data)
            .then(() => {
                alert("Registro guardado exitosamente.");
            })
            .catch((error) => {
                console.error("Error al guardar el registro diario:", error);
                alert("Hubo un problema al guardar el registro. Intenta nuevamente.");
            });
    }

    // Eliminar el registro diario en el backend
    function deleteDailyLogFromDatabase() {
        axios.delete(`/api/daily-log`)
            .then(() => {
                dailyLog = [];
                calorieGoal = 2000;
                document.getElementById('calorieGoal').value = calorieGoal;
                updateDailyLog();
                alert("Se ha iniciado un nuevo registro diario.");
            })
            .catch((error) => {
                console.error("Error al eliminar el registro diario:", error);
                alert("Error al eliminar el registro. Intenta nuevamente.");
            });
    }

    // Buscar alimentos desde el backend
    function searchFoods(isNewSearch = false) {
        const query = document.getElementById('searchInput').value;

        if (!query) {
            alert("Por favor, introduce un término de búsqueda.");
            return;
        }

        if (isNewSearch) {
            currentOffset = 0;
            document.getElementById('searchResults').innerHTML = '';
        }

        axios.get(`/api/foods/search?query=${query}&limit=${limit}&offset=${currentOffset}`)
            .then((response) => {
                displayFoodResults(response.data.foods, isNewSearch);
                currentOffset += limit;
            })
            .catch((error) => {
                console.error("Error al buscar alimentos:", error);
                alert("Hubo un error al buscar los alimentos. Por favor, intenta de nuevo.");
            });
    }

    // Función para mostrar los alimentos en la tabla
    function displayFoodResults(results, isNewSearch) {
        const resultsContainer = document.getElementById('searchResults');

        if (!results || results.length === 0) {
            if (isNewSearch) {
                resultsContainer.innerHTML = '<p>No se encontraron alimentos.</p>';
            }
            document.getElementById('loadMoreButton').style.display = 'none';
            return;
        }

        let table = resultsContainer.querySelector('table');
        if (!table) {
            table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Descripción</th>
                        <th>Energía (kcal)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            resultsContainer.appendChild(table);
        }

        const tbody = table.querySelector('tbody');
        results.forEach((food) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.description}</td>
                <td>${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 'N/A'}</td>
                <td><button onclick="addToLog('${food.description}', ${food.foodNutrients.find(n => n.nutrientName === 'Energy')?.value || 0})">Añadir</button></td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('loadMoreButton').style.display = results.length === limit ? 'block' : 'none';
    }

    // Cargar más alimentos cuando se presiona el botón
    function loadMoreFoods() {
        searchFoods(false);
    }

    // Añadir alimentos al registro diario
    function addToLog(description, energy) {
        dailyLog.push({ description, energy });
        updateDailyLog();
    }

    // Actualizar el registro diario en el DOM
    function updateDailyLog() {
        const logContainer = document.getElementById('dailyLog');
        calorieGoal = parseInt(document.getElementById('calorieGoal').value) || 2000;
        logContainer.innerHTML = '';

        if (dailyLog.length === 0) {
            logContainer.innerHTML = '<p>No se han añadido alimentos.</p>';
            document.getElementById('calorieSummary').textContent = '';
            return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Energía (kcal)</th>
                    <th>Acción</th>
                </tr>
            </thead>
        `;

        const tbody = document.createElement('tbody');
        let totalCalories = 0;

        dailyLog.forEach((food, index) => {
            totalCalories += food.energy;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.description}</td>
                <td>${food.energy}</td>
                <td><button onclick="removeFromLog(${index})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        logContainer.appendChild(table);

        const calorieSummary = document.getElementById('calorieSummary');
        if (calorieGoal > 0) {
            const remainingCalories = calorieGoal - totalCalories;
            calorieSummary.textContent = `Calorías consumidas: ${totalCalories} kcal. ${
                remainingCalories >= 0
                    ? `Te faltan ${remainingCalories} kcal para alcanzar tu objetivo.`
                    : `Has excedido tu objetivo en ${Math.abs(remainingCalories)} kcal.`
            }`;
        } else {
            calorieSummary.textContent = `Calorías consumidas: ${totalCalories} kcal.`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDailyLogFromDatabase();
    });
</script>


</body>
</html>
