<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Home</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <meta charset='utf-8' />
  <meta name="_csrf" th:content="${_csrf.token}" />

  <!-- FullCalendar CSS y JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar/main.min.js"></script>
</head>
<body>
<div class="home-container">
  <h1>¡Hola, <span th:text="${user.username}">Usuario</span>!</h1>
  <p>Estamos felices de verte de nuevo. Aquí tienes un resumen rápido:</p>

  <div class="card-container">
    <!-- Card 1: Progreso -->
    <div class="card">
      <h3>Tu Progreso</h3>
      <p>IMC actual: <span th:text="${#numbers.formatDecimal(user.weight / ((user.height / 100) * (user.height / 100)), 2, 2)}">XX.XX</span></p>
      <button onclick="location.href='/profile'">Ver Perfil</button>
    </div>
    <!-- Card 2: Planes de Entrenamiento -->
    <div class="card">
      <h3>Planes de Entrenamiento</h3>
      <p>Consulta tus planes personalizados o explora nuevos.</p>
      <button onclick="location.href='/training-plans'">Ver Planes</button>
    </div>
    <!-- Card 3: Dietas -->
    <div class="card">
      <h3>Dietas</h3>
      <p>Consulta tus dietas o crea un nuevo plan nutricional.</p>
      <button onclick="location.href='/diets'">Ver Dietas</button>
    </div>
  </div>

  <!-- Calendario interactivo -->
  <div class="calendar-container">
    <h2>Calendario de Ejercicios</h2>
    <div id="calendar"></div>
  </div>

  <!-- Modal para registrar ejercicios -->
  <div id="exercise-modal" class="calendar-modal" style="display: none;">
    <div class="calendar-modal-content">
      <span class="calendar-modal-close" onclick="closeModal()">&times;</span>
      <h2>Registrar Ejercicios</h2>
      <form id="exercise-form">
        <label for="selected-date">Fecha:</label>
        <input type="text" id="selected-date" name="date" readonly />

        <label for="exercises">Ejercicios:</label>
        <textarea id="exercises" name="exercises" rows="4" required></textarea>

        <button type="button" onclick="saveExercise()">Guardar</button>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript para configurar el calendario -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    // Obtener el token CSRF desde la metaetiqueta
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    // Inicializar el calendario
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      selectable: true,
      events: '/api/exercises/get', // Llamada al backend para obtener los eventos
      dateClick: function (info) {
        openExerciseModal(info.dateStr);
      }
    });

    calendar.render();

    // Guardar el ejercicio y añadirlo al calendario
    window.saveExercise = function () {
      const date = document.getElementById('selected-date').value;
      const exercises = document.getElementById('exercises').value;

      if (date && exercises) {
        // Llamada al backend para guardar el ejercicio
        fetch('/api/exercises/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken // Incluir el token CSRF en el encabezado
          },
          body: JSON.stringify({
            date: date,
            description: exercises
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Error al guardar el ejercicio');
          }
          return response.text();
        })
        .then(message => {
          // Añadir el evento al calendario
          calendar.addEvent({
            title: exercises,
            start: date
          });
          alert(message);
          closeModal();
        })
        .catch(error => {
          alert('Error: ' + error.message);
        });
      } else {
        alert('Por favor, completa todos los campos antes de guardar.');
      }
    };
  });

  // Abrir el modal
  function openExerciseModal(date) {
    const modal = document.getElementById('exercise-modal');
    const dateInput = document.getElementById('selected-date');
    dateInput.value = date; // Mostrar la fecha seleccionada
    modal.style.display = 'block';
  }

  // Cerrar el modal
  function closeModal() {
    const modal = document.getElementById('exercise-modal');
    modal.style.display = 'none';
  }
</script>


</body>
</html>
