<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Home</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <meta charset='utf-8' />
  <meta name="_csrf" th:content="${_csrf.token}" />

  <!-- FullCalendar CSS y JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar/main.min.js"></script>

  <!-- Toastify CSS y JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- SweetAlert2 CSS y JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="home-container">
  <h1>¡Hola, <span th:text="${user.username}">Usuario</span>!</h1>
  <p>Estamos felices de verte de nuevo. Aquí tienes un resumen rápido:</p>

  <div class="card-container">
    <!-- Tarjetas de Progreso, Planes y Dietas -->
    <div class="card">
      <h3>Tu Progreso</h3>
      <p>IMC actual: <span th:text="${#numbers.formatDecimal(user.weight / ((user.height / 100) * (user.height / 100)), 2, 2)}">XX.XX</span></p>
      <button onclick="location.href='/profile'">Ver Perfil</button>
    </div>
    <div class="card">
      <h3>Planes de Entrenamiento</h3>
      <p>Consulta tus planes personalizados o explora nuevos.</p>
      <button onclick="location.href='/training-plans'">Ver Planes</button>
    </div>
    <div class="card">
      <h3>Dietas</h3>
      <p>Consulta tus dietas o crea un nuevo plan nutricional.</p>
      <button onclick="location.href='/diet'">Ver Dietas</button>
    </div>
  </div>

  <!-- Calendario interactivo -->
  <div class="calendar-container">
    <h2>Calendario de Ejercicios</h2>
    <div id="calendar"></div>
  </div>

  <!-- Modal para registrar ejercicios -->
  <div id="exercise-modal" class="calendar-modal" style="display: none;">
    <div class="calendar-modal-content">
      <span class="calendar-modal-close" onclick="closeModal()">&times;</span>
      <h2>Registrar Ejercicios</h2>
      <form id="exercise-form">
        <label for="selected-date">Fecha:</label>
        <input type="text" id="selected-date" name="date" readonly />

        <label for="exercises">Ejercicios:</label>
        <textarea id="exercises" name="exercises" rows="4" required></textarea>

        <button type="button" onclick="saveExercise()">Guardar</button>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      selectable: true,
      editable: false, // No permitir arrastrar eventos
      events: '/api/exercises/get',

      dateClick: function (info) {
        openExerciseModal(info.dateStr);
      },

      eventClick: function (info) {
        Swal.fire({
          title: 'Detalles del Ejercicio',
          html: info.event.title.replace(/\n/g, "<br>"),
          icon: 'info',
          confirmButtonText: 'Cerrar'
        });
      },

      eventContent: function (arg) {
        let eventContainer = document.createElement('div');
        eventContainer.style.display = 'flex';
        eventContainer.style.justifyContent = 'space-between';
        eventContainer.style.alignItems = 'center';
        eventContainer.style.padding = '5px';
        eventContainer.style.borderRadius = '6px';
        eventContainer.style.overflow = 'hidden';
        eventContainer.style.textOverflow = 'ellipsis';

        const maxTitleLength = 12;
        let truncatedTitle = arg.event.title.length > maxTitleLength
          ? arg.event.title.substring(0, maxTitleLength) + '...'
          : arg.event.title;

        let titleElement = document.createElement('span');
        titleElement.innerHTML = truncatedTitle;
        titleElement.title = arg.event.title; // Tooltip con el texto completo

        let deleteButton = document.createElement('span');
        deleteButton.innerHTML = '❌';
        deleteButton.style.cursor = 'pointer';
        deleteButton.style.marginLeft = '10px';

        deleteButton.addEventListener('click', function (e) {
          e.stopPropagation();
          Swal.fire({
            title: `¿Eliminar evento?`,
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar"
          }).then((result) => {
            if (result.isConfirmed) {
              fetch(`/api/exercises/delete/${arg.event.id}`, {
                method: 'DELETE',
                headers: { 'X-CSRF-TOKEN': csrfToken }
              })
              .then(response => response.ok ? arg.event.remove() : Promise.reject())
              .then(() => Toastify({
                text: "Ejercicio eliminado correctamente",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#4caf50"
              }).showToast())
              .catch(() => Toastify({
                text: "Error al eliminar el ejercicio",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#f44336"
              }).showToast());
            }
          });
        });

        eventContainer.appendChild(titleElement);
        eventContainer.appendChild(deleteButton);

        return { domNodes: [eventContainer] };
      }
    });

    calendar.render();

    window.saveExercise = function () {
      const date = document.getElementById('selected-date').value;
      const exercises = document.getElementById('exercises').value;

      if (date && exercises) {
        fetch('/api/exercises/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken,
          },
          body: JSON.stringify({
            date: date,
            description: exercises,
          }),
        })
        .then((response) => response.json())
        .then((exercise) => {
          calendar.addEvent({
            id: exercise.id,
            title: exercise.description,
            start: exercise.date,
          });
          Toastify({
            text: "Ejercicio guardado correctamente",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#4caf50"
          }).showToast();
          closeModal();
        })
        .catch((error) => {
          Toastify({
            text: "Error: " + error.message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#f44336"
          }).showToast();
        });
      } else {
        Toastify({
          text: "Por favor, completa todos los campos antes de guardar.",
          duration: 3000,
          close: true,
          gravity: "top",
          position: "right",
          backgroundColor: "#ff9800"
        }).showToast();
      }
    };

    function openExerciseModal(date) {
      const modal = document.getElementById('exercise-modal');
      const dateInput = document.getElementById('selected-date');
      dateInput.value = date;
      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('exercise-modal');
      modal.style.display = 'none';
    }

    // Cierra el modal al hacer clic fuera de él
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('exercise-modal');
      if (event.target === modal) {
        closeModal();
      }
    });

    // Cierra el modal con la "X"
    document.querySelector('.calendar-modal-close').addEventListener('click', closeModal);
  });
</script>

</body>
</html>
