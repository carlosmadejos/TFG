<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Administración de Planes de Entrenamiento</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div class="container">
    <h2>Administrar Planes de Entrenamiento</h2>

    <!-- Botón para crear un nuevo plan -->
    <a href="/admin/training-plans/create" class="button">Crear Nuevo Plan</a>

    <h3>Lista de Planes Existentes</h3>
    <table>
        <thead>
        <tr>
            <th>Nombre</th>
            <th>Nivel</th>
            <th>Duración (semanas)</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="plan : ${trainingPlans}">
            <td th:text="${plan.name}"></td>
            <td th:text="${plan.level}"></td>
            <td th:text="${plan.duration}"></td>
            <td>
                <a th:href="@{/training-plans/{id}(id=${plan.id})}" class="button">Ver Detalles</a>
                <button class="delete-button" th:data-id="${plan.id}">Eliminar</button>
            </td>
        </tr>
        </tbody>
    </table>

    <a href="/admin/dashboard" class="back-button">Volver al Panel de Administración</a>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".delete-button").forEach(button => {
            button.addEventListener("click", function() {
                let planId = this.getAttribute("data-id");

                Swal.fire({
                    title: "¿Estás seguro?",
                    text: "Esta acción no se puede deshacer.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Sí, eliminar"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Obtener el token CSRF desde las etiquetas meta
                        let csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
                        let csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

                        fetch(`/admin/training-plans/delete/${planId}`, {
                            method: "DELETE",
                            headers: {
                                [csrfHeader]: csrfToken,  // Agregar el token CSRF en la cabecera
                                "Content-Type": "application/json"
                            }
                        })
                        .then(response => {
                            if (!response.ok) throw new Error("Error al eliminar el plan");
                            return response.text();
                        })
                        .then(() => {
                            Swal.fire("Eliminado!", "El plan ha sido eliminado.", "success")
                                .then(() => location.reload());
                        })
                        .catch(() => {
                            Swal.fire("Error", "No se pudo eliminar el plan.", "error");
                        });
                    }
                });
            });
        });
    });
</script>


</body>
</html>
